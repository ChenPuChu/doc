在 **4 位模式** 下，1602A（HD44780 控制器）的命令和数据需要分两次传输，每次只发送 4 位数据。以下是完整的命令集以及 4 位模式的数据发送方式。

## **一、HD44780 指令集（Command Set）**

| 指令名称                               | 代码（16 进制）       | 说明                         |
| ---------------------------------- | --------------- | -------------------------- |
| **清屏** (Clear Display)             | `0x01`          | 清空显示内容，并将光标移动到起始位置 (0,0)   |
| **光标归位** (Return Home)             | `0x02`          | 光标返回原点 (0,0)，同时恢复屏幕移动状态    |
| **输入模式设置** (Entry Mode Set)        | `0x04` - `0x07` | 控制字符输入方向，是否自动滚动            |
| **显示控制** (Display Control)         | `0x08` - `0x0F` | 控制显示开关、光标和光标闪烁             |
| **光标/显示移动** (Cursor/Display Shift) | `0x10` - `0x1F` | 移动光标或整个显示内容                |
| **功能设置** (Function Set)            | `0x20` - `0x3F` | 设置数据总线宽度（4 位或 8 位）、行数、字符大小 |
| **CGRAM 地址设置** (Set CGRAM Address) | `0x40` - `0x7F` | 设定 CGRAM（自定义字符存储区）地址       |
| **DDRAM 地址设置** (Set DDRAM Address) | `0x80` - `0xFF` | 设定 DDRAM（显示字符存储区）地址        |
| **写入数据** (Write Data to RAM)       | `0x80` - `0xFF` | 写入一个字符到当前光标位置              |

---

## **二、4 位模式数据发送方式**

在 4 位模式下，每个 8 位指令或数据都要拆成两次 4 位发送。数据传输过程如下：

### **1. 4 位模式初始化**

4 位模式的初始化比较特殊，需要先使用 8 位模式发送指令，之后再切换到 4 位模式：

```c
delay(50);      // 上电后至少等待 50ms
send_command(0x03); // 发送 3（8 位模式）
delay(5);       // 等待 5ms
send_command(0x03); // 发送 3
delay(1);       // 等待 1ms
send_command(0x03); // 发送 3
send_command(0x02); // 发送 2（进入 4 位模式）

// 现在正式进入 4 位模式，开始配置 LCD
send_command(0x28); // 4 位模式、2 行、5x8 字符点阵
send_command(0x0C); // 显示开、光标关
send_command(0x06); // 文字从左向右写入
send_command(0x01); // 清屏
```

### **2. 发送命令**

在 4 位模式下，每次发送 8 位命令需要分成两次发送：

```c
void send_command(uint8_t command) {
    write_4bit(command >> 4, 0); // 先发送高 4 位
    write_4bit(command & 0x0F, 0); // 再发送低 4 位
}
```

### **3. 发送数据**

向 LCD 发送字符数据：

```c
void send_data(uint8_t data) {
    write_4bit(data >> 4, 1); // 先发送高 4 位
    write_4bit(data & 0x0F, 1); // 再发送低 4 位
}
```

### **4. 4 位数据写入（核心函数）**

```c
void write_4bit(uint8_t data, uint8_t rs) {
    digitalWrite(RS, rs);  // RS = 0（命令），RS = 1（数据）
    digitalWrite(D4, (data >> 0) & 1);
    digitalWrite(D5, (data >> 1) & 1);
    digitalWrite(D6, (data >> 2) & 1);
    digitalWrite(D7, (data >> 3) & 1);
    
    // 触发使能信号
    digitalWrite(EN, HIGH);
    delayMicroseconds(1);
    digitalWrite(EN, LOW);
    delayMicroseconds(100);
}
```

---

## **三、完整的初始化和字符显示**

```c
void lcd_init() {
    pinMode(RS, OUTPUT);
    pinMode(EN, OUTPUT);
    pinMode(D4, OUTPUT);
    pinMode(D5, OUTPUT);
    pinMode(D6, OUTPUT);
    pinMode(D7, OUTPUT);

    delay(50);  // LCD 上电后需要等待至少 50ms

    send_command(0x03);
    delay(5);
    send_command(0x03);
    delay(1);
    send_command(0x03);
    send_command(0x02); // 进入 4 位模式

    send_command(0x28); // 4 位模式，2 行，5x8 字符
    send_command(0x0C); // 开启显示，关闭光标
    send_command(0x06); // 文字从左向右写入
    send_command(0x01); // 清屏
}

void lcd_print(const char *str) {
    while (*str) {
        send_data(*str++);
    }
}

void setup() {
    lcd_init();
    lcd_print("Hello, LCD!");
}
```

---

## **四、命令详解**

|指令名称|代码 (HEX)|说明|
|---|---|---|
|**清屏**|`0x01`|清除屏幕，并将光标归零|
|**光标归位**|`0x02`|光标归位，同时恢复显示位置|
|**模式设置**|`0x04~0x07`|`0x06` 代表输入模式，光标右移|
|**显示控制**|`0x08~0x0F`|`0x0C` 代表显示开，光标关|
|**光标移动**|`0x10~0x1F`|`0x14` 代表光标右移，`0x10` 代表光标左移|
|**功能设置**|`0x20~0x3F`|`0x28` 代表 4 位模式，2 行显示，5x8 字符|
|**CGRAM 地址**|`0x40~0x7F`|设定 CGRAM 地址，自定义字符|
|**DDRAM 地址**|`0x80~0xFF`|设定 DDRAM 地址，控制光标位置|

---

## **五、显示字符示例**

```c
send_data('H');
send_data('e');
send_data('l');
send_data('l');
send_data('o');
```

会在屏幕上显示 `Hello`。

---

## **六、设置光标位置**

```c
send_command(0x80 | 0x00); // 设置光标到第一行第 0 列
send_command(0x80 | 0x40); // 设置光标到第二行第 0 列
```

---

## **总结**

- **4 位模式下，每次发送 8 位数据需要分两次发送（高 4 位 + 低 4 位）**。
- **初始化时，必须先发送 3 次 `0x03`，然后发送 `0x02` 进入 4 位模式**。
- **使用 `send_command()` 发送命令，使用 `send_data()` 发送字符数据**。
- **`write_4bit()` 负责真正的 4 位数据写入 LCD**。

### **七、1602A LCD（HD44780 控制器）详细资料**

#### **1. LCD 引脚定义**

1602A 液晶屏有 16 个引脚，其中最主要的 6 个是控制和数据传输引脚：

|引脚|名称|说明|
|---|---|---|
|1|VSS|地 (GND)|
|2|VDD|电源 (+5V)|
|3|V0|对比度调整（接电位器中间，通常 0~1V 之间）|
|4|RS|寄存器选择：0 = 命令，1 = 数据|
|5|RW|读写选择：0 = 写入，1 = 读取（通常接地，只写入）|
|6|E|使能信号（上升沿触发）|
|7|D0|数据线（8 位模式用）|
|8|D1|数据线（8 位模式用）|
|9|D2|数据线（8 位模式用）|
|10|D3|数据线（8 位模式用）|
|11|D4|数据线（4 位/8 位模式）|
|12|D5|数据线（4 位/8 位模式）|
|13|D6|数据线（4 位/8 位模式）|
|14|D7|数据线（4 位/8 位模式）|
|15|LED+|背光正极 (+5V)|
|16|LED-|背光负极 (GND)|

#### **2. 4 位模式的控制信号时序**

在 4 位模式下，每个字节的传输需要两次 4 位发送，时序如下：

1. **RS = 0（命令模式） 或 RS = 1（数据模式）**
2. **RW = 0（写模式）**
3. **发送高 4 位**
    - 设置 D4-D7（高 4 位数据）
    - EN = 1（高电平触发）
    - EN = 0（完成数据锁存）
4. **发送低 4 位**
    - 设置 D4-D7（低 4 位数据）
    - EN = 1（高电平触发）
    - EN = 0（完成数据锁存）

#### **3. CGRAM（自定义字符）**

1602A 具有 **CGRAM**（Character Generator RAM），用于存储用户自定义字符，每个字符占用 8 字节。

- **CGRAM 地址范围**：`0x40` - `0x7F`
- **每个字符占 8 字节**
- **最多存 8 个字符**

##### **示例：自定义"笑脸"字符**

```c
uint8_t smiley[8] = {
    0b00000,
    0b01010,
    0b01010,
    0b00000,
    0b10001,
    0b01110,
    0b00000,
    0b00000
};

void lcd_create_char(uint8_t location, uint8_t *charmap) {
    location &= 0x07; // 只能存 8 个字符
    send_command(0x40 | (location << 3));
    for (int i = 0; i < 8; i++) {
        send_data(charmap[i]);
    }
}
```

调用 `lcd_create_char(0, smiley);` 后，`send_data(0);` 就可以在 LCD 上显示这个笑脸字符。

---

#### **4. 1602A 物理结构**

- **16x2 显示区域**：共 **32 个字符**，每个字符 **5x8 点阵**
- **内存结构**
    - **DDRAM（显示数据 RAM）**：存储屏幕显示字符
    - **CGRAM（自定义字符 RAM）**：存储自定义字符
    - **字符编码**：使用 ASCII 或者扩展字符集

##### **DDRAM 地址映射**

|位置|第一行 DDRAM 地址|第二行 DDRAM 地址|
|---|---|---|
|1|0x00|0x40|
|2|0x01|0x41|
|3|0x02|0x42|
|...|...|...|
|16|0x0F|0x4F|

要移动光标到 **第二行第 3 列**：

```c
send_command(0x80 | (0x40 + 2));  // 0x40 + 2 = 0x42
```

---

#### **5. 低功耗工作模式**

- **降低 LED 背光亮度**：PWM 控制 LED+ 供电
- **降低 MCU 供电电压**：使用 3.3V，但需逻辑电平转换
- **降低刷新率**：减少 `send_data()` 频率

---

#### **6. 1602A 兼容的其他液晶型号**

1602A 使用 **HD44780** 控制器，兼容以下型号：

- 2004A（20x4 显示）
- 1604A（16x4 显示）
- 0802A（8x2 显示）
- I2C 版本（PCF8574 I/O 扩展）

---

### **完整初始化和 Hello World 示例**

```c
void lcd_init() {
    pinMode(RS, OUTPUT);
    pinMode(EN, OUTPUT);
    pinMode(D4, OUTPUT);
    pinMode(D5, OUTPUT);
    pinMode(D6, OUTPUT);
    pinMode(D7, OUTPUT);

    delay(50);  // 上电等待

    send_command(0x03);
    delay(5);
    send_command(0x03);
    delay(1);
    send_command(0x03);
    send_command(0x02); // 进入 4 位模式

    send_command(0x28); // 4 位模式, 2 行, 5x8 字符
    send_command(0x0C); // 开启显示, 关闭光标
    send_command(0x06); // 文字从左向右写入
    send_command(0x01); // 清屏
}

void lcd_print(const char *str) {
    while (*str) {
        send_data(*str++);
    }
}

void setup() {
    lcd_init();
    lcd_print("Hello, 1602A!");
}
```

---

### **总结**

1. **4 位模式需要分两次传输 8 位数据（高 4 位+低 4 位）**
2. **初始化必须先用 `0x03` 进入 8 位模式，再 `0x02` 进入 4 位模式**
3. **CGRAM 可存储 8 个自定义字符**
4. **1602A 是 HD44780 兼容的，适用于各种 LCD**
5. **DDRAM 0x80 设置光标，0x40 是第二行起始地址**
6. **PWM 控制 LED+ 可降低功耗**

1602A 是一种常见的字符型液晶显示屏，通常用于嵌入式项目中。它是基于 HD44780 控制器的字符 LCD 显示屏，支持显示两行，每行 16 个字符。

### 1. **规格**

- **显示类型**：字符 LCD
- **分辨率**：2行 × 16字符（2×16）
- **显示模式**：单色背光（通常为绿色或蓝色）
- **控制器**：HD44780 或兼容芯片
- **接口**：并行接口（4位模式或8位模式）
- **电源电压**：通常为 5V（也有 3.3V 版本）
- **背光电压**：通常为 5V
- **字符点阵**：5×8 像素

### 2. **引脚定义**（常见的 16 引脚布局）

|引脚编号|名称|功能描述|
|---|---|---|
|1|VSS|地 (GND)|
|2|VDD|电源正极 (通常为 5V)|
|3|V0|对比度调节|
|4|RS|寄存器选择 (0：指令寄存器，1：数据寄存器)|
|5|RW|读/写控制 (0：写，1：读)|
|6|EN|使能信号 (低到高跳变触发操作)|
|7|D0|数据线 (数据传输的低位)|
|8|D1|数据线|
|9|D2|数据线|
|10|D3|数据线|
|11|D4|数据线|
|12|D5|数据线|
|13|D6|数据线|
|14|D7|数据线 (数据传输的高位)|
|15|A|背光正极|
|16|K|背光负极|

### 3. **工作模式**

1602A 屏幕支持两种工作模式：

- **4位模式**：只使用 D4-D7 数据线。只需 4 条数据线即可进行通信，节省了 GPIO 端口。
- **8位模式**：使用 D0-D7 数据线，可以进行更快的数据传输，但需要更多的 GPIO 端口。

### 4. **初始化过程**

典型的初始化过程如下：

1. 发送初始化命令（函数设置命令），以设置模式（4位或8位）和显示参数。
2. 设置显示使能、光标控制等功能。
3. 开启显示、关闭光标等。

### 5. **常用指令**

- **清屏**：`0x01`
- **光标归位**：`0x02`
- **显示开/关**：`0x08`（0x08关闭，0x0C开启，0x0E开启并显示光标）
- **光标左移**：`0x10`
- **光标右移**：`0x14`
- **设置字符模式**：`0x28`（设置为 5×8 点阵模式）

### 6. **编程库**

有很多开发平台可以控制 1602A 显示屏，常见的开发库：

- **Arduino**：`LiquidCrystal` 库
- **Raspberry Pi**：可以通过 I2C 或直接使用 GPIO 控制
- **STM32**：可以使用 HAL 库或者直接访问 GPIO 控制

### 7. **电路连接**

- **VSS** 连接到地（GND）
- **VDD** 连接到 +5V 电源
- **V0** 连接到可调电位器（用于调节对比度）
- **RS**、**RW**、**EN** 控制 LCD 操作（可以通过 GPIO 控制）
- **D0-D7** 用于数据传输，通常使用 4 位或 8 位模式连接
- **A** 和 **K** 用于背光（连接到 +5V 和 GND）

### 8. **常见问题**

- **显示不清晰**：通常是对比度设置不当，可以通过调整 V0 引脚的电位器来调整。
- **显示乱码**：检查是否正确初始化，确保发送正确的指令和数据。
